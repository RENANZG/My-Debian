__________________________________________________________________________

## 1. DEBIAN GNU/LINUX AND HARDENING

![thedoortofreedom](https://github.com/RENANZG/My-Debian-GNU-Linux/assets/53377291/f24266c3-b530-4586-adaa-55bbd808f7eb)


### 1.1 System Hardening Must Have

<table>
  <tr>
   <td><a href="https://anonymousplanet.org/" target="_blank"><b>Anonymous Planet</b> - The Hitchhiker’s Guide</a><a href="https://anonymousplanet.org/export/guide.pdf" target="_blank">&nbsp(PDF)</a></td>
   <td><a href="https://www.virustotal.com/gui/home/upload" target="_blank"><b>Virus Total</b> - Free virus, malware and URL online scanning</a></td>
  </tr>
   <tr>
  <td><a href="https://www.whonix.org/wiki/Essential_Host_Security" target="_blank"><b>Whonix</b> - Essential Host Security</a></td>
  <td><a href="https://github.com/PartialVolume/shredos.x86_64" target="_blank"><b>ShredOS</b> - Secure disk erasure/wipe</a></td>
  </tr>
  <tr>
  <td><a href="https://www.whonix.org/wiki/System_Hardening_Checklist" target="_blank"><b>Whonix</b> - System Hardening Checklist</a></td>
  <td><a href="https://cryptomator.org/" target="_blank"><b>Cryptomator</b> - Put a lock on your cloud</a></td>
  </tr>
  <tr>
  <td><a href="https://www.kicksecure.com/wiki/Documentation" target="_blank"><b>Kicksecure</b> - Documentation</a></td>
  <td><a href="https://madaidans-insecurities.github.io/"><b>Madaidan's</b> - Security & Privacy Evaluations</a></td>
  </tr>
  <tr>
  <td><a href="https://www.cisecurity.org/benchmark/debian_linux" target="_blank"><b>CIS Benchmark</b> - Debian Linux Guides</a></td>
  <td><a href="https://ssd.eff.org/" target="_blank"><b>EFF</b> - Surveillance Self-defense</a></td>
  </tr>
  <tr>
  <td><a href="https://www.nsa.gov/Press-Room/Cybersecurity-Advisories-Guidance" target="_blank"><b>NSA GOV</b> - Cybersecurity Advisories & Guidance</a><a href="https://github.com/nsacyber" target="_blank">&nbsp(GitHub)</a></td>
  <td><a href="https://wiki.debian.org/SecurityManagement" target="_blank"><b>Debian</b> - Security Management</a></td>
  </tr>
  <tr>
  <td><a href="https://www.nist.gov/cyberframework" target="_blank"><b>NIST GOV</b> - Cybersecurity Framework</a></td>
  <td><a href="https://www.duplicati.com/" target="_blank"><b>Duplicati</b> - Store securely encrypted backups on cloud storage services!</a></td>
    </tr>
</table>

### 1.2 Essential Tools

<table>
  <tr>
    <td><a href="https://www.ventoy.net/en/download.html" target="_blank"><b>1. Ventoy</b></a></td>
    <td><a href="https://www.ventoy.net/en/doc_secure.html" target="_blank">(Secure Boot)</a></td>
    <td><a href="https://www.ventoy.net/en/download.html" target="_blank">(Checksums)</a></td>
     <td><a href="https://tails.net/news/new_domain/index.en.html" target="_blank"><b>6. Tails</b></a></td>
    <td><a href="https://tails.net/contribute/design/UEFI/archive/" target="_blank">(Secure Boot)</a></td>
    <td><a href="https://tails.net/install/index.en.html" target="_blank">(Checksums)</a></td>
  </tr>
<tr>
   <td><a href="http://www.rodsbooks.com/refind/getting.html" target="_blank"><b>2. rEFInd</b></a></td>
    <td><a href="http://www.rodsbooks.com/refind/secureboot.html" target="_blank">(Secure Boot)</a></td>
    <td><a href="https://sourceforge.net/p/refind/code/ci/master/tree/" target="_blank">(Checksums)</a></td> 
    <td><a href="https://www.kali.org/get-kali/#kali-installer-images" target="_blank"><b>7. KaliLinux</b></a></td>
    <td><a href="" target="_blank">(Secure Boot)</a></td>
    <td><a href="" target="_blank">(Checksums)</a></td>
  </tr>
 <tr>
    <td><a href="https://clonezilla.org/downloads.php" target="_blank"><b>3. Clonezilla</b></a></td>
    <td><a href="https://clonezilla.org/downloads.php" target="_blank">(Secure Boot)</a></td>
    <td><a href="https://clonezilla.org/downloads.php" target="_blank">(Checksums)</a></td>
    <td><a href="https://www.openpgp.org/software/" target="_blank"><b>8. OpenPGP</b></a></td>
    <td><a href="https://github.com/OpenPGP/openpgp.org" target="_blank">(Git Hub)</a></td>
    <td><a href="https://keys.openpgp.org/" target="_blank">(Checksums)</a></td>
  </tr>
  <tr>
    <td><a href="https://gparted.org/livecd.php" target="_blank"><b>4. GParted</b></a></td>
    <td><a href="https://gparted.org/download.php" target="_blank">(Secure Boot)</a></td>
    <td><a href="https://gparted.org/gpg-verify.php" target="_blank">(Checksums)</a></td>
    <td><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-intro?view=windows-11" target="_blank"><b>9. WinPE</b></a></td>
    <td><a href="https://sergeistrelec.name/" target="_blank">(Sergei)</a></td>
    <td><a href="https://sergeistrelec.name/version_history_en.html" target="_blank">(Checksums)</a></td>
  </tr>
  <tr>
    <td><a href="https://github.com/PartialVolume/shredos.x86_64" target="_blank"><b>5. ShredOS</b></a></td>
    <td><a href="" target="_blank">(Secure Boot)</a></td>
    <td><a href="" target="_blank">(Checksums)</a></td>
    <td><a href="https://www.hirensbootcd.org/" target="_blank"><b>10. Hiren's BootCD PE</b></a></td>
    <td><a href="" target="_blank">(Secure Boot)</a></td>
    <td><a href="https://www.hirensbootcd.org/download/" target="_blank">(Checksums)</a></td>
   </tr>
</table>

<sub>
How to check the iso file (SHA256SUMS) - https://www.gnu.org/software/coreutils/manual/html_node/Summarizing-files.html  
<details>
<summary>Manual method</summary>  
<p>The SHA-256 checksum hashes in a file called SHA256SUMS in the same directory listing as the download page.</p>
<p>First open a terminal and go to the correct directory to check a downloaded iso file:  </p>
<p>cd download_directory  </p>
<p>Then run the following command from within the download directory.  </p>
<p>sha256sum name.iso  </p>
<p>sha256sum should then print out a single line after calculating the hash:  </p>
<p>sdd31231c0421be56f39c7a31245c423fgcc3b048ds321a3e83d2c4d714fa9a76 *name.iso  </p>
<p>Compare the hash (the alphanumeric string on left) that your machine calculated with the corresponding hash in the SHA256SUMS file.  </p>
</details>

</table>
<details>
<summary>Semi-automatic method</summary>  
<p>First download the SHA256SUMS and SHA256SUMS.gpg files to the same directory as the iso. Then run the following commands in a terminal.  </p>
<p>cd download_directory  </p>
<p>sha256sum -c SHA256SUMS 2>&1 | grep OK  </p>
<p>The sha256sum line should output a line such as:  </p>
<p>name.iso: OK  </p>
<p>If the OK for your file appears, that indicates the hash matches.  </p>
</details>  
<br></br>
</sub>

__________________________________________________________________________

## 2. SYSTEM INSTALLATION 

<details>
<summary><b>2.1 Hardware</b></summary>  
<p></p>

• Points to check:

2.1.1 Security  
https://en.wikipedia.org/wiki/Hardware-based_full_disk_encryption    

2.1.2 Compatibility  
https://linux-hardware.org    

2.1.3 Performance  

2.1.4 Cost benefit  

<p></p>
</details>  

<details>
<summary><b>2.2 Installation</b></summary>  
<p></p>

2.2.1 Installation Guides:  
Linux on UEFI:A Quick Installation Guide  
http://www.rodsbooks.com/linux-uefi/  
Linux Dabbler - Scripts to run after installing debian  
https://github.com/linuxdabbler/debian-install-scripts  
Nilsmeyer - An ansible role for bootstrapping new Debian based systems, including setting up partitions, file systems, encryption (luks), RAID and LVM  
https://github.com/nilsmeyer/ansible-debootstrap  

2.2.2 Partitioning scenarios: advantages and disadvantages:
https://wiki.archlinux.org/title/dm-crypt/Encrypting_an_entire_system  
https://wiki.archlinux.org/title/dm-crypt/Device_encryption#top-page   

2.2.3 Encryption:
https://wiki.archlinux.org/title/Security      
https://wiki.archlinux.org/title/Data-at-rest_encryption    
https://en.wikipedia.org/wiki/Disk_encryption#Implementations    
https://csrc.nist.gov/Projects/cryptographic-module-validation-program/fips-140-2 

<br></br>
</details>  

<details>
<summary><b>2.3 Key File Encryption in Debian 12 (Bookworm) References</b></summary> 
<ul>
<li>https://github.com/aomgiwjc/Unix-Bootstrap-Installs/wiki/Debian-BTRFS-Luks-Encryption-Installation-Method---Jan.-2023</li>
<li>https://cloudkid.fr/unlock-a-luks-partition-with-a-usb-key</li>
<li>https://blog.fidelramos.net/software/unlock-luks-usb-drive</li>
<li>https://tqdev.com/2022-luks-with-usb-unlock</li>
<li>https://www.willhaley.com/blog/unlock-luks-volumes-with-usb-key</li>
<li>https://www.dwarmstrong.org/fde-debian</li>
<li>https://www.cyberciti.biz/hardware/cryptsetup-add-enable-luks-disk-encryption-keyfile-linux</li>
<li>https://github.com/aomgiwjc/Unix-Bootstrap-Installs.wiki.git</li>
</ul>
<br></br>
</details>  
<br></br>

__________________________________________________________________________

## 3. DEBIAN SECURE BOOT 

<details>
<summary><b>3.1 Introduction</b></summary>  
<p></p>

    "Most modern systems will ship with SB enabled - they will not run any unsigned code by default, but it is possible to change the firmware configuration to either disable SB or to enroll extra signing keys." "The whole point of Secure Boot is to prevent malware from gaining control of the computer. Therefore, when booting with Secure Boot active, Fedora 18 and later, Ubuntu 16.04 and later, and probably other distributions restrict actions that some Linux users take for granted. For instance, Linux kernel modules must be signed, which complicates use of third-party kernel drivers, such as Nvidia's and AMD/ATI's proprietary video drivers. More recent kernels may, if Secure Boot is active, also check that they were launched from a boot loader that honors Secure Boot, and shut down if this was not the case.    
    To launch a locally-compiled kernel, you must sign it with a MOK and register that MOK with the system. (In both cases, you can register a hash rather than sign the binary; but this approach results in an ever-growing database in NVRAM, which is undesirable.) The extent of such restrictions is entirely up to those who develop and sign the boot loader launched by Shim and the kernel launched by that boot loader, though. Some distributions ship kernels that are relatively unencumbered by added security restrictions.  
    As a practical matter, if you want to use Shim, you have two choices: You can run a distribution that provides its own signed version of Shim, such as Fedora 18 or later or Ubuntu 12.10 or later; or you can run a signed version from such a distribution or from another source, add your own MOK, and sign whatever binaries you like. This first option is quite straightforward if you happen to want to use a distribution that ships with Shim, and it requires little extra elaboration." "If you want to build and run your own kernel (e.g. for development or debugging), then you will obviously end up making binaries that are not signed with the Debian key. If you wish to use those binaries, you will need to either sign them yourself and enroll the key used with MOK or disable SB."    
<p></p>
</details>  

<details>
<summary>3.2 Secure Boot References</summary>  
<ul>

<b>BASIC</b>
<li>https://www.rodsbooks.com/efi-bootloaders</li>
<li>https://www.rodsbooks.com/efi-bootloaders/secureboot.html</li>
<li>https://www.rodsbooks.com/efi-bootloaders/controlling-sb.html</li>
<li>https://ubuntu.com/blog/how-to-sign-things-for-secure-boot</li>
<li>https://wiki.ubuntu.com/UEFI/SecureBoot/DKMS</li>
<li>https://help.ubuntu.com/community/DKMS</li>
<li>https://github.com/sitmsiteman/secure-boot-in-debian-based-distro</li>
<li>https://github.com/Batu33TR/secureboot-mok-keys</li>
<li>https://github.com/M-P-P-C/Signing-an-Ubuntu-Kernel-for-Secure-Boot</li>
<li>https://medium.com/@vvvrrooomm/practical-secure-boot-for-linux-d91021ae6471</li>
<li>https://www.lastdragon.net/?p=2513</li>

<b>ADVANCED</b>
<li>https://uefi.org</li>
<li>https://www.kernel.org/doc/html/v4.15/admin-guide/module-signing.html</li>
<li>https://docs.oracle.com/en/operating-systems/oracle-linux/secure-boot/toc.htm#Table-of-Contents</li>
<li>https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/managing_monitoring_and_updating_the_kernel/signing-a-kernel-and-modules-for-secure-boot_managing-monitoring-and-updating-the-kernel</li>
<li>https://ubs_csse.gitlab.io/secu_os/tutorials/linux_secure_boot.html</li>
<li>https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot</li>
<li>https://wiki.archlinux.org/title/GRUB/EFI_examples#top-page</li>
<li>https://wiki.gentoo.org/wiki/Signed_kernel_module_support</li>
<li>https://stack.nexedi.com/P-VIFIB-Enhanced.UEFI.Secure.Boot.Debian</li>
<li>https://manpages.debian.org/buster/openssl/config.5ssl.en.html</li>
<li>https://manpages.debian.org/stretch/keyutils/keyctl.1.en.html</li>
<li>https://manpages.debian.org/testing/pesign/pesign.1.en.html</li>
<li>https://manpages.debian.org/testing/libnss3-tools/index.html</li>
<li>https://www.openssl.org/docs/man1.0.2/man1/openssl-req.html</li>
<li>https://www.openssl.org/docs/man1.1.1/man1/req.html</li>
<li>https://www.openssl.org/docs/manmaster/man5/x509v3_config.html</li>
<li>https://www.kicksecure.com/wiki/Verified_Boot</li>
<li>https://0pointer.net/blog/authenticated-boot-and-disk-encryption-on-linux.html</li>
<li>https://github.com/nsacyber/TrustedSHIM</li>
<li>https://github.com/nsacyber/HIRS</li>
<li>https://askubuntu.com/questions/762254/why-do-i-get-required-key-not-available-when-install-3rd-party-kernel-modules</li>
<li>https://help.eset.com/efs/8.1/en-US/secure-boot.html</li>
<li>https://help.ggcircuit.com/knowledge/how-to-inject-custom-secure-boot-keys-example</li>
<li>https://blogs.oracle.com/linux/post/the-machine-keyring</li>
<li>https://paldan.altervista.org/signed-linux-kernel-deb-creation-how-to/?doing_wp_cron=1690057748.1645970344543457031250 </li>
<li>https://www.linuxjournal.com/content/take-control-your-pc-uefi-secure-boot</li>
<li></li>
</ul>
</details>  

<details>
<summary>3.3 YouTube Video References</summary>  
<ul>
<li><a href="https://www.youtube.com/watch?v=Mqh9o8YY2dg" target="_blank">Use UEFI Secure Boot NOW! (Trafotin)</a></li>
<li><a href="https://www.youtube.com/watch?v=WBemkwMHLJM" target="_blank">Best Practices for UEFI Secure Boot Customization (UEFIForum)</a></li>
<li><a href="https://www.youtube.com/watch?v=jtLQ8SzfrDU" target="_blank">Secure Boot from A to Z (The Linux Foundation)</a></li>
<li><a href="https://www.youtube.com/watch?v=_3mwK6AXo_k" target="_blank">Secure Boot. In Debian. In Buster. Really (DebConf Videos)</a></li>
<li><a href="https://www.youtube.com/watch?v=33-CL2fBvlE" target="_blank">EFI secure boot con Debian 11 (La cueva del ultimo dragon Last Dragon)</a></li>
</ul>
</details> 

-------------------------------------------------------------------------

## $\textcolor{green}{Basic\ Tutorial}$  

👷🛠️UNDER WORK🚧🏗    
```diff
- Caution:The instructions provided here assume that you're signing a module for the currently running kernel. If you're signing a module for a different kernel, you must provide the path to the sign-file utility within the correct kernel version source. Otherwise, the signature type for the module for that kernel might not align correctly with the expected signature type.
- Note:UEFI specifications use the terms key and public key to mean the public part of the key pair, or the X.509 certificate. However, in OpenSSL, the term key is the private key that's used for signing. Thus, all Secure Boot keys must be X.509 keys and not OpenSSL keys.
- Only a single custom certificate can be added to the kernel because the compressed size of the kernel's boot image can not increase. Do not add multiple certificates to the kernel boot image.
- Debian Bug report logs - #989463 please align shim-signed dkms behaviour with Ubuntu  
- https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=989463  
- Debian Bug report logs - #928300 shim-signed: secure boot via removable media path unavailable  
- https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=928300  
- Debian Bug report logs - #939392 please provide kmodsign like Ubuntu does
- https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=939392
```  
<DIV class="section" id="VERDE">
<details>
<summary><b>Sign Debian 12 (Bookworm) Kernel for Secure Boot</b></summary>  
<p></p>

<b>1.First steps </b>   

Has the system booted via Secure Boot?
```
$ sudo mokutil --sb-state
SecureBoot enabled
```
If controlling the Secure Boot state through the EFI setup program is difficult, you can optionally use the mokutil utility to disable Secure Boot at the level of the Shim so that, although UEFI Secure Boot is enabled, no further validation takes place after the Shim is loaded.

What keys are on my system?
```
$ sudo mokutil --list-enrolled
or
$ sudo mokutil --list-enrolled | grep Subject:
```

Also the command <ins>modinfo</ins> prints the signature if available, for example:
```
$ sudo modinfo /lib/modules/6.1.0-11-amd64/kernel/mm/zsmalloc.ko 
```

<b>2.Place to auto-generated MOK</b>

MOK - Machine Owner Key

<details>
<summary><b>Introduction</b></summary>  
The use of mokutil that's most relevant to this page is to import a MOK. In this context, importing refers to storing a MOK in the computer's NVRAM, along with a flag to tell Shim and MokUtil that the MOK is there and ready to be enlisted when you next reboot the computer. Keys can be added and removed in the MOK list by the user, entirely separate from the distro CA key. Unlike Debian, Ubuntu has chosen to place their auto-generated MOK at "/var/lib/shim-signed/mok/", which some software--such as Oracle's virtualbox package -expect to be present. Note that using this same location may result in future conflicts. Warning: The MOK.key file is extremely sensitive! An attacker who gains access to it could generate binaries that your computer would accept as authorized. You should change permissions to prevent unauthorized access, and ideally store it on an encrypted external storage medium and unplug it when you're not signing binaries.If you see the key there (consisting of the files MOK.der, MOK.pem and MOK.priv) then you can use these, rather than creating your own.
</details>

First make sure the key doesn't exist yet:
```
$ ls /var/lib/shim-signed/mok/
```
To create a folder to MOK key:
```
$ sudo mkdir -p /var/lib/shim-signed/mok/
```
You can choose another placcautione like "/etc/mok_key/" since there is no standard location at the moment.
```
$ sudo mkdir -p /etc/mok_key/
```

<b>3.Generating a new key</b>

Before you create the public and private key for signing the kernel, you need to access the folder you created to be the destination of the keys. Then create the public (mokcertificate.der) and private key (moksigningkey.priv) with one-time password for signing the kernel
```
$ cd /var/lib/shim-signed/mok/
$ sudo openssl req -config $(openssl version -d) -new -x509 -newkey rsa:2048 -keyout MOK.priv -outform DER -out MOK.der -days 36500 -subj "/CN=ShimSigned/"

```
```
$ sudo openssl x509 -in MOK.der -inform DER -outform PEM -out MOK.pem
$ ls -l 
total 12
-rw-r--r-- 1 root root  787  MOK.der
-rw-r--r-- 1 root root 1123  MOK.pem
-rw------- 1 root root 1854  MOK.priv
$ sudo chmod 600 /var/lib/shim-signed/mok/*
```
This commands will create both the private and public part of the certificate to sign things. You need both files to sign; and just the public part (MOK.der) to enroll the key in Shim.

To read the certificate file in a human readable format, use
```
$ sudo openssl x509 -in /var/lib/shim-signed/mok/MOK.pem -noout -text 
```

Another example of key generation:
```
$ sudo openssl req -x509 -new -nodes -utf8 -sha512 -days 3650 -batch -config /etc/ssl/x509.conf -outform DER -out /etc/ssl/certs/pubkey.der -keyout /etc/ssl/certs/priv.key
$ sudo openssl x509 -inform DER -in /etc/ssl/certs/pubkey.der -out /etc/ssl/certs/pubkey.pem
```


--------------------------------------------------------------
<b>4.Enrolling your key im Shim</b>

Enroll the key to your installation:

```
$ cd /var/lib/shim-signed/mok/
$ sudo mokutil --import MOK.der
```
You will be asked for a one-time <b>password (remember it and type it correctly)</b>, you will just use it to confirm your key selection in the next step (you won't need this password beyond this point, though), so choose any.

Recheck your key will be prompted on next boot
```
$ sudo mokutil --list-new
```
<b>5.Restart and finsh the process</b>

Restart your system. Changes to the MOK keys may only be confirmed directly from the console at boot time. You will encounter a blue screen of a tool called MOKManager. Select "Enroll MOK" and then "View key". Make sure it is your key you created in step 3. Afterwards continue the process and you must enter the password which you provided in step 4. Continue with booting your system.

Verify your key is already enrolled, if the MOK was loaded correctly, with:
```
$ sudo mokutil --test-key /var/lib/shim-signed/mok/MOK.der
```

<b>6.Sign your installed kernel or modules</b>

<DIV class="subsection" id="6.1" >
<details>
<summary><b>6.1 Modern Method: </b> Signing the Debian kernel and modules with DKMS</summary> 

Building Debian kernel modules with DKMS. The dkms frameworks allows building kernel modules "on the fly" on the local system instead of building them centrally on the Debian infrastructure, DKMS could automatically sign kernel updated modules. If you install the kernel modules through the apt repository, chances are that modules have already been signed by the DKMS signing key. In that case, the traditional method won't work. And the thing you only need to do is to enroll the DKMS signing key into your machine. On systems that use SecureBoot, you will need a Machine Owner Key (MOK) to load DKMS modules. Generate it, enroll it, sign modules with it and then you will be able to load the signed modules. 

In Debian, it depends on the dkms package:
```
$ sudo apt install dkms
```
In order for dkms to automatically sign kernel modules, it must be told which key to sign the module with. This is done by adding two configuration values to "/etc/dkms/framework.conf", adjusting paths as required:

  mok_signing_key="/var/lib/shim-signed/mok/MOK.priv"
  mok_certificate="/var/lib/shim-signed/mok/MOK.der"

<\details>

<DIV class="subsubsection" id="6.2.1">
<details>
<summary><b>DKMS Sign Helper Script</b></summary>  
<p></p>
If these values are provided and dkms is able to build modules but does not attempt to sign them, then it is likely that sign_tool is missing. This is more common in older and/or custom kernels.
In "/etc/dkms/framework.conf", add:
```
sign_tool="/etc/dkms/sign_helper.sh"
```
Create "/etc/dkms/sign_helper.sh" with:
```
/lib/modules/"$1"/build/scripts/sign-file sha512 /root/.mok/client.priv /root/.mok/client.der "$2"
```
Set Linux kernel info variables
```
$ VERSION="$(uname -r)"
$ SHORT_VERSION="$(uname -r | cut -d . -f 1-2)"
$ MODULES_DIR=/lib/modules/$VERSION
$ KBUILD_DIR=/usr/lib/linux-kbuild-$SHORT_VERSION
```
<\details> 

<DIV class="subsubsection" id="6.2.2">
<details>
<summary>Making DKMS modules signing by DKMS signing key usable with the secure boot</summary>  
<p></p>
If you install the kernel modules through the apt repository, chances are that modules have already been signed by the DKMS signing key. In that case, the traditional method won't work. And the thing you only need to do is to enroll the DKMS signing key into your machine. Here is how we can do that:

First, use the method mentioned in Verifying if a module is signed to check if the modules are signed by DKMS signing key.

Next, find the location of the mok signing key and mok certificate. You can view the location in /etc/dkms/framework.conf, and the default location is /var/lib/dkms.

Then, run the following command to enroll the key into the machine:
```
$ sudo mokutil --import /var/lib/dkms/mok.pub # prompts for one-time password and /var/lib/mok.pub can be changed, if mok certificate isn't located there.
$ sudo mokutil --list-new # recheck your key will be prompted on next boot

<rebooting machine then enters MOK manager EFI utility: enroll MOK, continue, confirm, enter password, reboot>

$ sudo dmesg | grep cert # verify your key is loaded
```
<\details> 
</DIV>
</DIV>
</DIV>

<DIV class="subsection" id="6.2">  
<details>  
<summary><b>6.2 Traditional Method:</b> signing the Debian kernel with sbsigntool</summary>  
<p></p>

Building and signing modules is independent of building and signing your own kernel (vmlinuz). To sign a custom kernel or any other EFI binary you want to have loaded by Shim, you’ll need to use a different command: sbsign (PEM). In this case, we’ll need the certificate in a different format, <ins>mokutil</ins> needs DER, <ins>sbsign</ins> needs PEM. Convert the certificate into PEM (.der to .pem), for example:
```
$ sudo openssl x509 -in MOK.der -inform DER -outform PEM -out MOK.pem
```
For example, use it to sign our Kernel:
```
$ sudo sbsign --key MOK.priv --cert MOK.pem "/boot/vmlinuz-$VERSION" --output "/boot/vmlinuz-$VERSION.tmp"
$ sudo mv "/boot/vmlinuz-$VERSION.tmp" "/boot/vmlinuz-$VERSION"
```
For example, use it to sign our EFI binary:
```
$ sudo sbsign --key MOK.priv --cert MOK.pem grubx64.efi --output grubx64.efi.signed
$ sudo mv "grubx64.efi.signed" "grubx64.efi"
```

Sign the installed Kernel using the key created according to the location you gave it, this will create a new signed vmlinuz. Sign vmlinuz using sbsign and .pem certificate, it should be at /boot/vmlinuz-[KERNEL-VERSION]:

To check your Kernel version, you can also use the command:
```
$ uname -r
6.1.0-12-amd64
```
Signing vmlinuz (kernel) using sbsign:
```
$ sudo sbsign --key MOK.priv --cert MOK.pem /boot/vmlinuz-[KERNEL-VERSION] --output /boot/vmlinuz-[KERNEL-VERSION].signed
```
For example
```
$ sudo sbsign --key /var/lib/shim-signed/mok/MOK.priv --cert /var/lib/shim-signed/mok/MOK.pem "/boot/vmlinuz-6.1.0-12-amd64" --output "/boot/vmlinuz-6.1.0-12-amd64.signed"
```
alternatively:
```
$ cd /var/lib/shim-signed/mok/
$ sudo sbsign --key MOK.priv --cert MOK.pem "/boot/vmlinuz-[KERNEL-VERSION] --output "/boot/vmlinuz-[KERNEL-VERSION].signed"
```
Remove the unsigned one and restore the original name of the signed one, this will create a new signed vmlinuz: 
```
$ sudo mv "/boot/vmlinuz-6.1.0-12-amd64.signed" "/boot/vmlinuz-6.1.0-12-amd64"
```
Update your grub-config
```
$ sudo update-grub
```
Reboot your system and select the signed kernel. Now your system should run under a signed kernel and upgrading GRUB2 works again. If you want to upgrade the custom kernel, you can sign the new version easily by following above steps again from step seven on. Thus BACKUP the MOK-keys (MOK.der, MOK.pem, MOK.priv) in an encrypted device.  

Verifying if a module is signed. The command modinfo prints the signature if available, for example:
```
$ sudo modinfo /boot/vmlinuz-6.1.0-12-amd64
```
Others commands
```
$ sudo dmesg | grep cert
$ sudo sbverify --list /boot/vmlinuz-6.1.0-12-amd64
$ sudo sbverify --cert /etc/mok_key/mok.crt /boot/vmlinuz-6.1.0-12-amd64
```
<p></p>
</details>  
</DIV>
</DIV>
</DIV>  

<details>
<summary><b>Reset Secure Boot keys for Kernel or Modules</b></summary>  
<p></p>
Reset Key for Kernel
---UNDER WORK---
https://www.rodsbooks.com/efi-bootloaders/controlling-sb.html#setuputil

"The ASUS permits to you restore the default keys, so this isn't really vital if you're starting from the factory defaults with this model; but if yours doesn't offer such a reset-to-defaults option or if you've modified the keys, saving them may be prudent. As the name implies, this option also erases all your Secure Boot keys. (It does not erase your MOKs, though.)"

**Reset MOK Keys for Modules**
---UNDER WORK---
https://www.rodsbooks.com/efi-bootloaders/controlling-sb.html#key-revocation

```
$ sudo mokuitil --sb-state
  SecureBoot disabled
```
```
$ sudo mokutil --disable-validation
```
Backup. Exports to list (ideally store it on an encrypted external storage medium).
```
$ sudo mokutil --export
```
Shows all keys.
```
$ sudo ls -1 MOK*
```
Shows you keys enrolled.
```
$ sudo mokutil --list-enrolled | grep Subject:
```
Delete those not enrolled to maintain secure boot.
```
$ sudo mokutil --delete MOK-0001.der
```
To remove all (MOKs being a list and not just a single MOK, you can make the shim trust keys from several different vendors, allowing dual and multi-boot)
```
$ sudo mokutil --reset --mok
```
```
$ sudo mokutil --reset
```
Uninstall the modules, if it was made with script "make".
```
$ cd ~/realtekwifi
$ sudo make uninstall
```
Reset de modules and unload them in Kernel
```
$ sudo depmod 
$ sudo update-initramfs -u -k all
```
</details>   

<p></p>

-------------------------------------------------------------------------------------------------

## $\textcolor{gold}{Intermediate\ Tutorial}$  

<p></p>

```diff
- Building and signing kernel modules is independent of building and signing your own kernel.
- If you have already created your own keys (for example, the files MOK.der, MOK.pem and MOK.priv), then you can use these rather than creating your own.
```

👷🛠️🚧🏗  

<details>
<summary><b>Sign WIFI Module for Secure Boot</b></summary>  
  <p></p>

How to get WiFi Module signed for Secure Boot

1. You can create a personal public/private RSA key pair to sign the kernel modules. You can chose to store the key/pair, for example, in the <ins>/var/lib/shim-signed/modules/</ins> directory. Then create a new pair of private key (module.priv) and public key (module.der).

```
$ sudo mkdir /var/lib/shim-signed/modules
$ sudo openssl req -config $(openssl version -d) -new -x509 -newkey rsa:2048 -nodes -days 36500 -outform DER -keyout "/var/lib/shim-signed/modules/module.priv" -out "/var/lib/shim-signed/modules/module.der" -subj "/CN=Modules/"
$ ls -l /var/lib/shim-signed/modules/
total 8
-rw-r--r-- 1 root root  779 module.der
-rw------- 1 root root 1704 module.priv
```

2. Enroll the public key (VirtualBox.der) to MOK (Machine Owner Key) by entering the command:
```
$ sudo mokutil --import /var/lib/shim-signed/modules/module.der
input password:
input password again:
```
Recheck if your key will be prompted on next boot:
```
$ sudo mokutil --list-new
```

3. Reboot and check

The password in this step is a temporary use password you'll only need to remember for a few minutes. Reboot the machine. When the bootloader starts, you should see a screen asking you to press a button to enter the MOK manager EFI utility. Note that any external external keyboards won't work in this step. Select Enroll MOK in the first menu, then continue, and then select Yes to enroll the keys, and re-enter the password established in previous step. Then select OK to continue the system boot.

Verify if your key "Modules" is loaded and signed

```
$ sudo mokutil --test-key /var/lib/shim-signed/modules/module.der
$ sudo lsmod | grep rtw88_8723d
$ sudo modinfo -n rtw88_8723d
$ sudo dmesg | grep cert
$ sudo dmesg | grep Modules
```

4. Sign the module 

Where was the module installed?
```
$ sudo modinfo -n rtw88_8723d
  /lib/modules/6.1.0-12-amd64/kernel/drivers/net/wireless/realtek/rtw88/rtw88_8723d.ko
```
For sing the module, depending on your platform, the exact location of `sign-file` might vary. In Debian 12 (Bookworm) it was in <ins>/usr/src/linux-headers-$(uname -r)/scripts/sign-file</ins> .

```
$ uname -r
  6.1.0-12-amd64
$ /usr/src/linux-headers-6.1.0-12-amd64/scripts/sign-file 
Usage: scripts/sign-file [-dp] <hash algo> <key> <x509> <module> [<dest>]
       scripts/sign-file -s <raw sig> <hash algo> <x509> <module> [<dest>]
```
Sign the module:
```
$ sudo /usr/src/linux-headers-6.1.0-12-amd64/scripts/sign-file sha256 /var/lib/shim-signed/modules/module.priv /var/lib/shim-signed/modules/module.der /lib/modules/6.1.0-12-amd64/kernel/drivers/net/wireless/realtek/rtw88/rtw88_8723d.ko
```
Verify it:
```
$ sudo modinfo rtw88_8723d
(...)
signer:         Modules
sig_key:        XX:XX:XX:XX:XX:XX:XX:XX...
sig_hashalgo:   sha256
signature:      XX:XX:XX:XX:XX:XX:XX:XX...
(...)
```
If you have your own keys:
```
$ sudo /usr/src/linux-headers-$(uname -r)/scripts/sign-file sha256 /var/lib/shim-signed/mok/MOK.priv /var/lib/shim-signed/mok/MOK.der /lib/modules/6.1.0-12-amd64/misc/vboxdrv.ko
```

Other form
```
$ sudo /usr/src/linux-headers-$(uname -r)/scripts/sign-file sha256 ./MOK.priv ./MOK.der "$(modinfo -n vboxdrv)"

```
If the modules are needed to boot your machine, make sure to update the initramfs, e.g. using
```
sudo update-initramfs -k all -u
```

-------------------------------------------------------------------------------------------------

Building and signing modules is independent of building and signing your own kernel. To sign a custom kernel or any other EFI binary you want to have loaded by shim (PEM), you’ll need to use a different command: sbsign (PEM). In this case, we’ll need the certificate in a different format, <ins>mokutil</ins> needs DER, <ins>sbsign</ins> needs PEM. Convert the certificate into PEM (.der to .pem), for example:
```
$ sudo openssl x509 -in MOK.der -inform DER -outform PEM -out MOK.pem
```
For example, use it to sign our Kernel:
```
$ sudo sbsign --key MOK.priv --cert MOK.pem "/boot/vmlinuz-$VERSION" --output "/boot/vmlinuz-$VERSION.tmp"
$ sudo mv "/boot/vmlinuz-$VERSION.tmp" "/boot/vmlinuz-$VERSION"
```
For example, use it to sign our EFI binary:
```
$ sudo sbsign --key MOK.priv --cert MOK.pem my_binary.efi --output my_binary.efi.signed
```
As long as the signing key is enrolled in shim and does not contain the Object Identifier (OID) from earlier (since that limits the use of the key to kernel module signing), the binary should be loaded just fine by shim.

5.  VirtualBox Sign Helper Script

Future kernel updates would require the updated kernels to be signed again, so it makes sense to put the signing commands in a script that can be run at a later date as necessary (DKMS package could do it automatically).

```
$ sudo touch /var/lib/shim-signed/modules/sign-modules
$ sudo nano /var/lib/shim-signed/modules/sign-modules

#!/bin/bash

for modfile in $(dirname $(modinfo -n <yourmodulehere>))/*.ko; do
  echo "Signing $modfile"
  /usr/src/linux-headers-$(uname -r)/scripts/sign-file sha256 \
                                /var/lib/shim-signed/modules/module.priv \
                                /var/lib/shim-signed/modules/module.der "$modfile"
done
```
Add execution permission, and run the script above as root from the /var/lib/shim-signed/modules/ directory.
```
$ sudo -i
$ cd /var/lib/shim-signed/modules
$ chmod 700 /var/lib/shim-signed/modules/sign-vbox-modules ./sign-vbox-modules
```
Load vboxdrv module and launch VirtualBox.
```
$ sudo modprobe vboxdrv
or
$ /sbin/modprobe vboxdrv 
```
<p></p>
</details> 

<details>
<summary><b>Sign NVIDIA Module for Secure Boot</b></summary>  
<p></p>
https://github.com/NVIDIA/open-gpu-kernel-modules  
https://askubuntu.com/questions/1023036/how-to-install-nvidia-driver-with-secure-boot-enabled    
  
Download the latest driver from the NVIDIA website: https://www.geforce.com/drivers.

Create a new pair of private key (Nvidia.key) and public key (Nvidia.der) by running the command:

`openssl req -new -x509 -newkey rsa:2048 -keyout PATH_TO_PRIVATE_KEY -outform DER -out PATH_TO_PUBLIC_KEY -nodes -days 36500 -subj "/CN=Graphics Drivers"`
Example:

`openssl req -new -x509 -newkey rsa:2048 -keyout /home/itpropmn07/Nvidia.key -outform DER -out /home/itpropmn07/Nvidia.der -nodes -days 36500 -subj "/CN=Graphics Drivers"`
Enroll the public key (nvidia.der) to MOK (Machine Owner Key) by entering the command:

`sudo mokutil --import PATH_TO_PUBLIC_KE`
Example:

`sudo mokutil --import /home/itpropmn07/Nvidia.der`
This command requires you to create a password for enrolling. Afterwards, reboot your computer, in the next boot, when the system asks you to enroll, you enter the password you created in this step to enroll it. Read more: https://sourceware.org/systemtap/wiki/SecureBoot

For installing the NVidia driver for the first time, you need to disable the Nouveau kernel driver by entering the command:

`echo options nouveau modeset=0 | sudo tee -a /etc/modprobe.d/nouveau-kms.conf; sudo update-initramfs -u`

Reboot.

Install the driver by entering the command:

`sudo sh ./XXXXXX.run -s --module-signing-secret-key=PATH_TO_PRIVATE_KEY --module-signing-public-key=PATH_TO_PUBLIC_KEY`

where:

XXXXXX: name of file installer (downloaded from NVIDIA).

PATH_TO_PRIVATE_KEY: full path to private key. If you place it in your home folder, use /home/USER_NAME/ instead of ~.

PATH_TO_PUBLIC_KEY: full path to public key. If you place it in your home folder, use /home/USER_NAME/ instead of ~.

Example:

`sudo sh ./NVIDIA-Linux-x86_64-390.67.run -s --module-signing-secret-key=/home/itpropmn07/Nvidia.key --module-signing-public-key=/home/itpropmn07/Nvidia.der`

Done.
  
</details> 


<details>
<summary><b>Sign VirtualBox Module for Secure Boot</b></summary>  
<p></p>

How to get VirtualBox signed for Secure Boot


</details> 


<details>
<summary><b>Sign Ventoy</b></summary>  

</details>   


<details>
<summary><b>rEFInd Bootloader</b></summary>  
<p></p>
https://wiki.ubuntu.com/EFIBootLoaders  

</details>   

<p></p>

<details>
<summary><b>OpenSSL Error - No such file</b></summary>  
<p></p>
<pre>
Error
At main.c:298:
- SSL error:FFFFFFFF80000002:system library::No such file or directory: ../crypto/bio/bss_file.c:67
- SSL error:10000080:BIO routines::no such file: ../crypto/bio/bss_file.c:75
</pre>

See: <a href="https://zhuanlan.zhihu.com/p/582707348">SSL error:10000080:BIO routines::no such file: crypto/bio/bss_file.c:75</a>   
See: <a href="https://stackoverflow.com/questions/70365875/error-during-creation-self-signed-ssl-with-openssl">Error during creation self-signed SSL with openSSL</a>   
See: <a href="https://docs.kernel.org/admin-guide/module-signing.html">Kernel module signing facility</a>   

<b>Possible cause:</b>
To sign a custom kernel or any other EFI binary you want to have loaded by shim, you’ll need to use a different command: sbsign. Unfortunately, we’ll need the certificate in a different format in this case, <ins>mokutil</ins> needs DER, <ins>sbsign</ins> needs PEM. Convert the certificate into PEM (.der to .pem):

<pre>
$ sudo openssl x509 -in MOK.der -inform DER -outform PEM -out MOK.pem
</pre>

Use it to sign our EFI binary:    
<pre>
sbsign --key MOK.priv --cert MOK.pem my_binary.efi --output my_binary.efi.signed
</pre>
As long as the signing key is enrolled in shim and does not contain the Object Identifier (OID) from earlier (since that limits the use of the key to kernel module signing), the binary should be loaded just fine by shim.    
<b>Using syntax by mistake:</b>
*Man Page OpenSSL:    
<a href="https://www.openssl.org/docs/man1.0.2/man1/openssl-req.html">Man OpenSSL</a>   
<pre>
$ sudo openssl req -x509 -new -nodes -utf8 -sha256 -days 36500 -batch -config openssl.cnf -outform DER -out MOK.der -keyout MOK.priv
$ sudo openssl req -x509 -new -nodes -utf8 -sha256 -days 36500 -batch -outform DER -out MOK.der -keyout MOK.priv
$ sudo openssl req -x509 -new -nodes -utf8 -sha256 -days 36500 -batch -config openssl.cnf -outform DER -out MOK.der -keyout MOK.priv
$ sudo openssl req -x509 -new -nodes -utf8 -sha256 -days 36500 -batch -outform DER -out MOK.der -keyout MOK.priv
</pre>
*Ubuntu:    
<a href="https://ubuntu.com/blog/how-to-sign-things-for-secure-boot">https://ubuntu.com/blog/how-to-sign-things-for-secure-boot</a>   
<pre>
$ sudo openssl req -config ./openssl.cnf -new -x509 -newkey rsa:2048 -nodes -days 36500 -outform DER -keyout "MOK.priv" -out "MOK.der"
</pre>
*Debian:    
<a href="https://wiki.debian.org/SecureBoot">https://wiki.debian.org/SecureBoot</a>
<pre>
$ sudo openssl req -new -x509 -newkey rsa:2048 -keyout MOK.priv -outform DER -out MOK.der -days 36500 -subj "/CN=My Name/"
$ sudo openssl x509 -inform der -in MOK.der -out MOK.pem
</pre>
*Fedora:    
<a href="https://docs.fedoraproject.org/en-US/quick-docs/kernel-build-custom/">https://docs.fedoraproject.org/en-US/quick-docs/kernel-build-custom/</a>
<pre>
$ sudo openssl req -new -x509 -newkey rsa:2048 -keyout "key.pem" -outform DER -out "cert.der" -nodes -days 36500 -subj "/CN=<your name>/"
</pre>
<b>Workaround:</b>

This is where Debian places openssl.cnf for the OpenSSL they provide:
<pre>
S openssl version -d
OPENSSLDIR: "/usr/lib/ssl"
S ls -l /usr/lib/ssl
lrwxrwxrwx 1 root root   mmm 30 mm:mm openssl.cnf -> /etc/ssl/openssl.cnf
$ ls -l /etc/ssl/
-rw-r--r-- 1 root root   mmm 30 mm:mm openssl.cnf
</pre>

And this is where Ubuntu places openssl.cnf for the OpenSSL they provide:
<pre>
$ sudo ls /etc/ssl/
openssl.cnf
</pre>

 It is kind of buried in OpenSSL source code for apps.c, load_config and what happens when cnf is NULL (i.e., no -config option or OPENSSL_CONF envar). When cnf is NULL and no overrides, then OPENSSLDIR is used.

You can use strace (man strace) to check the configuration file being used while generating the self-signed certificate.
<pre>
$ strace -e trace=open,openat -o /tmp/strace.log.0 openssl req \
-newkey rsa:2048 -x509 -nodes -keyout localhost.key \
-new -out localhost.crt
...

$ grep "openssl.cnf" /tmp/strace.log.0
openat(AT_FDCWD, "/etc/pki/tls/openssl.cnf", O_RDONLY) = 3
</pre>

sudo cat /etc/ssl/openssl.cnf
openssl_conf = openssl_init from /etc/ssl/openssl.cnf
$(openssl version -d)

To override system default with user level environment:
An empty file will do:
touch ~/.openssl.cnf
BASH define & export:
export OPENSSL_CONF=~/.openssl.cnf
Wrap application within a script:
export OPENSSL_CONF=/dev/null

</details>

<p></p>

------------------------------------------------------------------------------------------------

## $\textcolor{red}{Advanced\ Tutorial}$ 

👷🛠️🚧🏗  

<details>  
<summary><b>Sign Custom Secure Keys</b></summary>  
<p></p>
https://github.com/nsacyber/Hardware-and-Firmware-Security-Guidance/blob/master/secureboot/Linux.md  

</details>   
<details>  
<summary><b>Sign with TPM 2.0</b></summary>  
<p></p>
https://github.com/squarooticus/efi-measured-boot  

</details>  

<br></br>

________________________________________________________________________________________

## 4. PRIVILEGES AND APPARMOR  


<br></br>
________________________________________________________________________________________

## 5. FIREWALL AND VPN  
👷🛠️UNDER WORK🚧🏗    

https://github.com/techlore/VPN-reviews    

**UFW**  

https://portchecker.co/  

**VPN**  
https://www.paulligocki.com/vpn-only-ufw-setup/  

**Leak Test**  
https://www.dnsleaktest.com/   
https://coveryourtracks.eff.org/  
https://ipleak.net/  

**Torrenting**  
https://github.com/LiamTheBox/Torrent-With-A-VPN  
https://github.com/mdlam92/vpn_torrenting  
https://github.com/tool-maker/VPN_just_for_torrents/wiki  
https://askubuntu.com/questions/559016/ufw-rules-dont-block-deluge  
https://transmissionbt.com/  

**UFW+VPN+qBittorrent**  

  
**Everyday TOR**  
https://www.whonix.org/wiki/Install_Tor_Browser_Outside_of_Whonix#Easy   

<br></br>

_______________________________________________________________________

## 6. SOFTWARES  
👷🛠️UNDER WORK🚧🏗    

<DIV>
<details>  
<summary><b></b></summary>  
</details>  

<details>  
<summary><b>Browsers</b></summary>  
<p style="line-height: 8px;"><b>Firefox</b>  </p>
<p style="margin : 0; padding-top:0;"><b>Chromium</b>  </p>
<p style="line-height: 8px;"><b>Extensions</b>  </p>
<p"><a href="https://chrome.google.com/webstore/detail/simple-speed-dial/gpdpldlbafdmhlmcdllcjgoigmpjonfc?hl=en-US">Simple Speed Dial</a>  </p>
<p><a href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm/related?hl=en-US">Ublock Origin</a>  </p>
<p><a href="https://chrome.google.com/webstore/detail/xbrowsersync/lcbjdhceifofjlpecfpeimnnphbcjgnc?hl=en-US">XBrowserSync</a>  </p>
<p><a href="https://chrome.google.com/webstore/detail/reader-view/ecabifbgmdmgdllomnfinbmaellmclnh/related?hl=en-US">Reaser View</a>  </p>
<p><a href="https://chrome.google.com/webstore/detail/myjdownloader-browser-ext/fbcohnmimjicjdomonkcbcpbpnhggkip">jDownloader</a>  </p>
</details>  

<details>  
<summary><b>Password Manager</b></summary>  
<a href=""></a></td>  
https://keepassxc.org/    
</details>  

<details>  
<summary><b>Email</b></summary>  
<a href=""></a></td>  
<p style="margin : 0; padding-top:0;">https://emailselfdefense.fsf.org/en/workshops.html  </p>
<p style="margin : 0; padding-top:0;">https://www.linuxbabe.com/security/encrypt-emails-gpg-thunderbird  </p>
<p style="margin : 0; padding-top:0;">https://keys.openpgp.org/about/usage  </p>
<p style="margin : 0; padding-top:0;">https://efail.de/</p>  
</details>  
</DIV>


###  MALWARES, BACKDOORS, ZERO-DAYS, DATA POISONING, SUPPLY CHAIN ATTACK, MAN-IN-THE-MIDDLE (MITM), HONEY POTS, AND SOCIAL ENGINEERING ATTACK    


### Some Links  
https://github.com/sbilly/awesome-security    
https://github.com/ernw/hardening    
https://github.com/jekil/hardentheworld    
https://www.youtube.com/@hitbsecconf/videos  

